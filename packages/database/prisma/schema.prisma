// AP2-Native Agent Payment Gateway - Prisma Schema
// Database: PostgreSQL 14+
// ORM: Prisma 5.x

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Agent {
  id         String   @id @default(cuid())
  name       String
  public_key String   @unique
  status     String   @default("active")
  risk_tier  String   @default("LOW")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  policies        Policy[]
  purchase_intents PurchaseIntent[]
  receipts        Receipt[]

  @@index([status])
  @@index([risk_tier])
  @@map("agents")
}

model Policy {
  id               String   @id @default(cuid())
  agent_id         String
  version          Int
  vendor_allowlist Json
  amount_cap       Int
  daily_cap        Int
  risk_tier        String   @default("LOW")
  x402_enabled     Boolean  @default(true)
  expires_at       DateTime
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  agent    Agent     @relation(fields: [agent_id], references: [id], onDelete: Cascade)
  mandates Mandate[]

  @@unique([agent_id, version])
  @@index([agent_id, expires_at])
  @@index([expires_at])
  @@map("policies")
}

model PurchaseIntent {
  id          String   @id @default(cuid())
  agent_id    String
  vendor      String
  amount      Int
  currency    String   @default("USD")
  description String
  metadata    Json     @default("{}")
  status      String   @default("PENDING")
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt

  agent   Agent     @relation(fields: [agent_id], references: [id], onDelete: Cascade)
  mandate Mandate?

  @@index([agent_id, created_at])
  @@index([status])
  @@index([vendor])
  @@map("purchase_intents")
}

model Mandate {
  id         String   @id @default(cuid())
  intent_id  String   @unique
  policy_id  String
  signature  String
  issued_at  DateTime @default(now())
  expires_at DateTime
  status     String   @default("ACTIVE")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  intent   PurchaseIntent @relation(fields: [intent_id], references: [id], onDelete: Cascade)
  policy   Policy         @relation(fields: [policy_id], references: [id], onDelete: Restrict)
  payments Payment[]

  @@index([status, expires_at])
  @@index([policy_id])
  @@map("mandates")
}

model Payment {
  id           String    @id @default(cuid())
  mandate_id   String
  provider     String
  provider_ref String?
  amount       Int
  currency     String    @default("USD")
  status       String    @default("INITIATED")
  settled_at   DateTime?
  created_at   DateTime  @default(now())
  updated_at   DateTime  @updatedAt

  mandate      Mandate             @relation(fields: [mandate_id], references: [id], onDelete: Restrict)
  receipt      Receipt?
  execution    AgentExecution?
  transactions WalletTransaction[]

  @@index([mandate_id])
  @@index([provider, status])
  @@index([status, created_at])
  @@map("payments")
}

model Receipt {
  id          String   @id @default(cuid())
  payment_id  String   @unique
  agent_id    String
  hash        String   @unique
  prev_hash   String?
  chain_index Int
  created_at  DateTime @default(now())

  payment Payment @relation(fields: [payment_id], references: [id], onDelete: Restrict)
  agent   Agent   @relation(fields: [agent_id], references: [id], onDelete: Cascade)

  @@index([agent_id, chain_index])
  @@index([agent_id, created_at])
  @@index([prev_hash])
  @@map("receipts")
}

model Idempotency {
  id          String   @id @default(cuid())
  route       String
  key         String
  payload     Json
  status_code Int
  response    Json     @default("{}")
  created_at  DateTime @default(now())

  @@unique([route, key])
  @@index([created_at])
  @@map("idempotency")
}

model VendorX402Endpoint {
  id         String   @id @default(cuid())
  vendor     String   @unique
  endpoint   String
  public_key String
  enabled    Boolean  @default(true)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([vendor, enabled])
  @@map("vendor_x402_endpoints")
}

// ==========================================
// AGENT ECONOMY MODELS (Phase 1)
// ==========================================

model Developer {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String
  verified          Boolean  @default(false)
  stripe_account_id String?
  api_key_hash      String?  @unique
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  agents  AgentDefinition[]
  revenue DeveloperRevenue[]

  @@index([email])
  @@index([verified])
  @@map("developers")
}

model AgentDefinition {
  id           String   @id
  developer_id String
  manifest     Json
  code_url     String
  status       String   @default("pending_review")
  downloads    Int      @default(0)
  rating       Float?
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  developer   Developer         @relation(fields: [developer_id], references: [id], onDelete: Cascade)
  versions    AgentVersion[]
  deployments AgentDeployment[]
  executions  AgentExecution[]

  @@index([developer_id])
  @@index([status])
  @@index([rating])
  @@map("agent_definitions")
}

model AgentVersion {
  id           String   @id @default(cuid())
  agent_id     String
  version      String
  manifest     Json
  code_url     String
  changelog    String?
  status       String   @default("active")
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  agent AgentDefinition @relation(fields: [agent_id], references: [id], onDelete: Cascade)

  @@unique([agent_id, version])
  @@index([agent_id, status])
  @@map("agent_versions")
}

model AgentDeployment {
  id         String   @id @default(cuid())
  agent_id   String
  user_id    String
  version    String
  config     Json     @default("{}")
  status     String   @default("active")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  agent      AgentDefinition  @relation(fields: [agent_id], references: [id], onDelete: Cascade)
  executions AgentExecution[]

  @@unique([agent_id, user_id])
  @@index([user_id])
  @@index([status])
  @@map("agent_deployments")
}

model AgentExecution {
  id            String    @id @default(cuid())
  agent_id      String
  deployment_id String
  inputs        Json
  outputs       Json?
  status        String    @default("pending")
  payment_id    String?   @unique
  error         String?
  started_at    DateTime?
  completed_at  DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  agent        AgentDefinition     @relation(fields: [agent_id], references: [id], onDelete: Cascade)
  deployment   AgentDeployment     @relation(fields: [deployment_id], references: [id], onDelete: Cascade)
  payment      Payment?            @relation(fields: [payment_id], references: [id], onDelete: SetNull)
  transactions WalletTransaction[]

  @@index([agent_id, status])
  @@index([deployment_id])
  @@index([status, created_at])
  @@map("agent_executions")
}

model DeveloperRevenue {
  id               String   @id @default(cuid())
  developer_id     String
  execution_id     String   @unique
  amount           Int
  currency         String   @default("USD")
  platform_fee     Int
  orchestrator_fee Int
  net_amount       Int
  paid_out         Boolean  @default(false)
  paid_at          DateTime?
  created_at       DateTime @default(now())

  developer Developer @relation(fields: [developer_id], references: [id], onDelete: Cascade)

  @@index([developer_id, paid_out])
  @@index([created_at])
  @@map("developer_revenue")
}

// ==========================================
// WALLET & TRANSACTION SYSTEM
// ==========================================

enum OwnerType {
  USER
  DEVELOPER
}

enum TransactionType {
  EXECUTION_EARNING    // Developer earns from execution
  EXECUTION_CHARGE     // User pays for execution
  WALLET_TOPUP         // User adds funds
  WITHDRAWAL           // Developer withdraws funds
  REFUND               // Execution refund
  ADJUSTMENT           // Manual admin adjustment
}

enum TransactionDirection {
  CREDIT
  DEBIT
}

enum PaymentMethod {
  WALLET
  CASHFREE
  STRIPE
  MANUAL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  REVERSED
}

enum WalletStatus {
  ACTIVE
  SUSPENDED
  CLOSED
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String
  verified   Boolean  @default(false)
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  @@index([email])
  @@index([verified])
  @@map("users")
}

model Wallet {
  id                String       @id @default(cuid())
  owner_type        OwnerType
  owner_id          String       // Foreign key to either User.id or Developer.id
  available_balance Int          @default(0) // Amount available for use
  pending_balance   Int          @default(0) // Amount held in pending transactions
  currency          String       @default("USD")
  status            WalletStatus @default(ACTIVE)
  created_at        DateTime     @default(now())
  updated_at        DateTime     @updatedAt

  transactions WalletTransaction[]

  @@unique([owner_type, owner_id])
  @@index([owner_type, owner_id])
  @@index([status])
  @@map("wallets")
}

model WalletTransaction {
  id                    String               @id @default(cuid())
  wallet_id             String
  counterparty_wallet_id String?             // For transfers between wallets
  execution_id          String?
  payment_id            String?
  type                  TransactionType
  direction             TransactionDirection
  method                PaymentMethod
  amount                Int                  // Transaction amount in smallest currency unit
  fee_amount            Int                  @default(0) // Fee charged for transaction
  currency              String               @default("USD")
  status                TransactionStatus    @default(PENDING)
  balance_after         Int?                 // Wallet balance after transaction
  metadata              Json                 @default("{}")
  idempotency_key       String?              @unique
  created_at            DateTime             @default(now())
  updated_at            DateTime             @updatedAt

  wallet               Wallet              @relation(fields: [wallet_id], references: [id], onDelete: Cascade)
  execution            AgentExecution?     @relation(fields: [execution_id], references: [id], onDelete: SetNull)
  payment              Payment?            @relation(fields: [payment_id], references: [id], onDelete: SetNull)

  @@index([wallet_id, status])
  @@index([wallet_id, created_at])
  @@index([type, status])
  @@index([execution_id])
  @@index([idempotency_key])
  @@map("wallet_transactions")
}
